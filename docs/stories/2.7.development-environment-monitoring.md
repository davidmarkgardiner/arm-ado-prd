# Story 2.7: Development Environment Monitoring Implementation

<!-- Powered by BMADâ„¢ Core -->

## Status
Draft

## Story
**As a** Platform Engineer,
**I want** to implement comprehensive monitoring for development environment,
**So that** I can proactively identify and resolve issues.

## Acceptance Criteria
1. Application performance monitoring implemented
2. Infrastructure health monitoring operational
3. Cost monitoring and alerting configured
4. Security monitoring integrated
5. Developer-facing dashboards created

## Tasks / Subtasks
- [ ] Deploy application performance monitoring tools (AC: 1)
  - [ ] Install and configure Application Insights
  - [ ] Set up distributed tracing with Jaeger
  - [ ] Configure custom application metrics collection
  - [ ] Implement application health check monitoring
  - [ ] Create application performance dashboards
- [ ] Configure infrastructure health monitoring (AC: 2)
  - [ ] Deploy Prometheus for metrics collection
  - [ ] Configure Grafana for visualization
  - [ ] Set up infrastructure health dashboards
  - [ ] Configure alerting rules for infrastructure issues
  - [ ] Implement cluster and node health monitoring
- [ ] Setup cost monitoring and budget alerts (AC: 3)
  - [ ] Configure Azure Cost Management integration
  - [ ] Set up cost allocation tags
  - [ ] Create cost monitoring dashboards
  - [ ] Configure budget alerts and thresholds
  - [ ] Implement cost optimization recommendations
- [ ] Integrate security monitoring and alerting (AC: 4)
  - [ ] Configure security event monitoring
  - [ ] Set up compliance monitoring dashboards
  - [ ] Integrate with Azure Security Center
  - [ ] Configure security incident alerting
  - [ ] Implement security metrics collection
- [ ] Create developer-facing dashboards (AC: 5)
  - [ ] Design developer experience dashboards
  - [ ] Create application-specific monitoring views
  - [ ] Implement self-service monitoring capabilities
  - [ ] Configure team-specific alert channels
  - [ ] Provide monitoring training to development teams
- [ ] Configure automated alerting for common issues (AC: 1, 2, 4)
  - [ ] Set up smart alerting rules with reduced noise
  - [ ] Configure escalation procedures
  - [ ] Implement alert grouping and correlation
  - [ ] Set up notification channels (Slack, email, PagerDuty)
  - [ ] Create alert runbooks and resolution procedures

## Dev Notes

### Previous Story Dependencies
This story builds on:
- Story 2.6 (Team Training): Teams must be trained on new workflows
- Story 2.5 (Environment Optimization): Environment must be optimized and stable
- All previous Epic 2 stories: Complete development environment must be operational

### Monitoring Architecture Overview
**Development Environment Monitoring Stack** [Source: architecture.md#observability-stack]:
```yaml
development_monitoring:
  application_monitoring:
    azure_application_insights:
      instrumentation: "auto"
      sampling_rate: "1.0"  # Full sampling for dev
      custom_metrics: "enabled"

    jaeger_tracing:
      sampling_strategy: "probabilistic"
      sampling_rate: "0.1"  # 10% sampling for dev

  infrastructure_monitoring:
    prometheus:
      scrape_interval: "30s"
      retention: "30d"
      storage: "20Gi"

    grafana:
      version: "latest"
      persistence: "enabled"
      anonymous_access: "enabled"  # For dev convenience

  cost_monitoring:
    azure_cost_management:
      budget_alerts: "enabled"
      daily_reports: "enabled"
      cost_allocation: "team_based"

  security_monitoring:
    azure_security_center:
      integration: "enabled"
      compliance_checks: "basic"
```

### Application Performance Monitoring
**Application Insights Configuration**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: appinsights-config
  namespace: applications
data:
  APPINSIGHTS_INSTRUMENTATIONKEY: "${APPINSIGHTS_KEY}"
  APPINSIGHTS_PROFILER_ENABLED: "true"
  APPINSIGHTS_SNAPSHOT_DEBUGGER_ENABLED: "true"
  APPINSIGHTS_LIVE_METRICS_ENABLED: "true"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dev-frontend-monitored
  namespace: applications
spec:
  template:
    spec:
      containers:
      - name: frontend
        image: company/frontend:dev-latest
        env:
        - name: APPINSIGHTS_INSTRUMENTATIONKEY
          valueFrom:
            configMapKeyRef:
              name: appinsights-config
              key: APPINSIGHTS_INSTRUMENTATIONKEY
        - name: OTEL_SERVICE_NAME
          value: "dev-frontend"
        - name: OTEL_RESOURCE_ATTRIBUTES
          value: "service.name=dev-frontend,service.version=1.0.0,environment=development"

        # Health check endpoints for monitoring
        livenessProbe:
          httpGet:
            path: /health/live
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10

        readinessProbe:
          httpGet:
            path: /health/ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5

        # Startup probe for better monitoring
        startupProbe:
          httpGet:
            path: /health/startup
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 2
          failureThreshold: 30
```

**Jaeger Distributed Tracing**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger-all-in-one
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:latest
        ports:
        - containerPort: 16686  # UI
        - containerPort: 14268  # HTTP collector
        - containerPort: 6831   # UDP compact
        - containerPort: 6832   # UDP binary
        env:
        - name: COLLECTOR_ZIPKIN_HTTP_PORT
          value: "9411"
        - name: MEMORY_MAX_TRACES
          value: "10000"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

---
apiVersion: v1
kind: Service
metadata:
  name: jaeger-service
  namespace: monitoring
spec:
  selector:
    app: jaeger
  ports:
  - name: ui
    port: 16686
    targetPort: 16686
  - name: collector-http
    port: 14268
    targetPort: 14268
```

### Infrastructure Health Monitoring
**Prometheus Configuration for Development**:
```yaml
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: dev-prometheus
  namespace: monitoring
spec:
  replicas: 1
  retention: "30d"
  storage:
    volumeClaimTemplate:
      spec:
        storageClassName: managed-premium
        resources:
          requests:
            storage: 20Gi

  serviceMonitorSelector:
    matchLabels:
      environment: development

  ruleSelector:
    matchLabels:
      environment: development

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

  additionalScrapeConfigs:
    name: dev-scrape-configs
    key: additional-scrape-configs.yaml

---
apiVersion: v1
kind: Secret
metadata:
  name: dev-scrape-configs
  namespace: monitoring
stringData:
  additional-scrape-configs.yaml: |
    # Development-specific scrape configurations
    - job_name: 'dev-applications'
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
          - applications
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)

    # Cost monitoring metrics
    - job_name: 'azure-cost-exporter'
      static_configs:
      - targets: ['azure-cost-exporter.monitoring.svc.cluster.local:8080']
```

**Development Environment Grafana Dashboards**:
```json
{
  "dashboard": {
    "title": "Development Environment Overview",
    "tags": ["development", "overview"],
    "panels": [
      {
        "id": 1,
        "title": "Application Health",
        "type": "stat",
        "targets": [
          {
            "expr": "up{job=\"dev-applications\"}",
            "legendFormat": "{{instance}}"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {"mode": "palette-classic"},
            "thresholds": {
              "steps": [
                {"color": "red", "value": 0},
                {"color": "green", "value": 1}
              ]
            }
          }
        }
      },
      {
        "id": 2,
        "title": "Response Time P95",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job=\"dev-applications\"}[5m])) by (le, service))",
            "legendFormat": "{{service}}"
          }
        ]
      },
      {
        "id": 3,
        "title": "Resource Utilization",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"applications\"}[5m])) by (pod)",
            "legendFormat": "CPU - {{pod}}"
          },
          {
            "expr": "sum(container_memory_working_set_bytes{namespace=\"applications\"}) by (pod)",
            "legendFormat": "Memory - {{pod}}"
          }
        ]
      },
      {
        "id": 4,
        "title": "Daily Cost Trend",
        "type": "graph",
        "targets": [
          {
            "expr": "azure_daily_cost{resource_group=\"dev-workloads-rg-001\"}",
            "legendFormat": "{{service}}"
          }
        ]
      }
    ]
  }
}
```

### Cost Monitoring Implementation
**Azure Cost Management Integration**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: azure-cost-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: azure-cost-exporter
  template:
    metadata:
      labels:
        app: azure-cost-exporter
        azure.workload.identity/use: "true"
    spec:
      serviceAccountName: azure-cost-exporter-sa
      containers:
      - name: cost-exporter
        image: company/azure-cost-exporter:latest
        ports:
        - containerPort: 8080
        env:
        - name: AZURE_SUBSCRIPTION_ID
          value: "${DEV_SUBSCRIPTION_ID}"
        - name: RESOURCE_GROUP_FILTER
          value: "dev-workloads-rg-001"
        - name: EXPORT_INTERVAL
          value: "3600"  # Export every hour
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: azure-cost-exporter-sa
  namespace: monitoring
  annotations:
    azure.workload.identity/client-id: "${COST_MONITORING_CLIENT_ID}"

---
# Cost budget alert configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: cost-budgets
  namespace: monitoring
data:
  budgets.yaml: |
    budgets:
      development_monthly:
        amount: 500  # $500 monthly budget
        threshold_alerts:
          - percentage: 50
            contacts: ["platform-team@company.com"]
          - percentage: 80
            contacts: ["platform-team@company.com", "finance-team@company.com"]
          - percentage: 100
            contacts: ["platform-team@company.com", "management@company.com"]
```

### Security Monitoring Integration
**Security Event Monitoring**:
```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: dev-security-alerts
  namespace: monitoring
  labels:
    environment: development
spec:
  groups:
  - name: security.rules
    rules:
    - alert: UnauthorizedPodCreation
      expr: increase(kubernetes_audit_total{verb="create",objectRef_resource="pods",user_username!~"system:.*"}[5m]) > 0
      for: 0m
      labels:
        severity: warning
        environment: development
      annotations:
        summary: "Unauthorized pod creation in development"
        description: "User {{ $labels.user_username }} created pod {{ $labels.objectRef_name }}"

    - alert: PrivilegedContainerDetected
      expr: kube_pod_container_status_privileged{namespace="applications"} == 1
      for: 1m
      labels:
        severity: critical
        environment: development
      annotations:
        summary: "Privileged container detected"
        description: "Pod {{ $labels.pod }} is running privileged containers"

    - alert: SecurityPolicyViolation
      expr: increase(gatekeeper_violations_total{environment="development"}[5m]) > 0
      for: 0m
      labels:
        severity: warning
        environment: development
      annotations:
        summary: "Security policy violation in development"
        description: "{{ $value }} policy violations detected"
```

### Developer-Facing Dashboards
**Team-Specific Application Dashboard**:
```json
{
  "dashboard": {
    "title": "Team ${TEAM_NAME} - Application Metrics",
    "tags": ["team-${TEAM_NAME}", "applications"],
    "panels": [
      {
        "title": "My Applications Status",
        "type": "table",
        "targets": [
          {
            "expr": "up{job=\"dev-applications\", team=\"${TEAM_NAME}\"}",
            "format": "table"
          }
        ]
      },
      {
        "title": "Request Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total{team=\"${TEAM_NAME}\"}[5m])) by (service)",
            "legendFormat": "{{service}}"
          }
        ]
      },
      {
        "title": "Error Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total{team=\"${TEAM_NAME}\", status=~\"5..\"}[5m])) by (service) / sum(rate(http_requests_total{team=\"${TEAM_NAME}\"}[5m])) by (service)",
            "legendFormat": "{{service}} error rate"
          }
        ]
      },
      {
        "title": "Resource Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(container_memory_working_set_bytes{namespace=\"applications\", pod=~\".*${TEAM_NAME}.*\"}) by (pod)",
            "legendFormat": "Memory - {{pod}}"
          }
        ]
      }
    ],
    "templating": {
      "list": [
        {
          "name": "TEAM_NAME",
          "type": "textbox",
          "query": "",
          "current": {
            "value": "frontend"
          }
        }
      ]
    }
  }
}
```

### Alert Configuration and Escalation
**Smart Alerting Configuration**:
```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: dev-smart-alerts
  namespace: monitoring
spec:
  groups:
  - name: development.alerts
    interval: 30s
    rules:
    # Application health alerts
    - alert: ApplicationDown
      expr: up{job="dev-applications"} == 0
      for: 2m
      labels:
        severity: warning
        environment: development
        team: "{{ $labels.team }}"
      annotations:
        summary: "Application {{ $labels.instance }} is down"
        description: "{{ $labels.instance }} has been down for more than 2 minutes"
        runbook_url: "https://runbooks.company.com/app-down"

    # Performance alerts
    - alert: HighResponseTime
      expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="dev-applications"}[5m])) by (le, service)) > 1
      for: 5m
      labels:
        severity: warning
        environment: development
      annotations:
        summary: "High response time for {{ $labels.service }}"
        description: "95th percentile response time is {{ $value }}s"

    # Resource alerts
    - alert: HighMemoryUsage
      expr: (container_memory_working_set_bytes{namespace="applications"} / container_spec_memory_limit_bytes{namespace="applications"}) > 0.9
      for: 5m
      labels:
        severity: warning
        environment: development
      annotations:
        summary: "High memory usage for {{ $labels.pod }}"
        description: "Memory usage is {{ $value | humanizePercentage }}"

    # Cost alerts
    - alert: DailyCostThresholdExceeded
      expr: azure_daily_cost{resource_group="dev-workloads-rg-001"} > 50
      for: 0m
      labels:
        severity: warning
        environment: development
      annotations:
        summary: "Daily cost threshold exceeded"
        description: "Daily cost is ${{ $value }}, exceeding $50 threshold"
```

## Testing

### Monitoring Coverage Testing
- Application performance metrics collection validation
- Infrastructure health monitoring accuracy
- Cost monitoring and budget alert functionality
- Security event detection and alerting

### Dashboard Functionality Testing
- Dashboard data accuracy and refresh rates
- User interface responsiveness and usability
- Team-specific dashboard customization
- Self-service monitoring capability validation

### Alert System Testing
- Alert trigger accuracy and timing
- Notification delivery to appropriate channels
- Alert escalation and resolution workflows
- False positive rate and alert noise levels

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*