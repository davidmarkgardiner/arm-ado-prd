# Story 1.16: Audit Logging Implementation

<!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** Security Engineer,
**I want** to implement comprehensive audit logging,
**So that** I can track all administrative actions.

## Acceptance Criteria
1. Kubernetes audit logging enabled
2. Audit logs forwarded to Azure Log Analytics
3. ASO controller logs centralized
4. Flux controller logs centralized
5. Security event correlation implemented

## Tasks / Subtasks
- [ ] Enable Kubernetes audit logging on management cluster (AC: 1)
  - [ ] Configure audit policy for comprehensive logging
  - [ ] Enable audit logging on AKS cluster
  - [ ] Configure audit log rotation and retention
  - [ ] Test audit log generation for various operations
- [ ] Configure audit log forwarding to Log Analytics (AC: 2)
  - [ ] Set up Azure Monitor Log Analytics workspace
  - [ ] Configure audit log shipping via Fluent Bit
  - [ ] Create log retention and archival policies
  - [ ] Validate audit log ingestion and searchability
- [ ] Setup centralized logging for ASO controllers (AC: 3)
  - [ ] Configure ASO controller structured logging
  - [ ] Set up log aggregation for ASO operations
  - [ ] Create ASO-specific log parsing and indexing
  - [ ] Implement ASO operation audit trail
- [ ] Configure Flux controller log aggregation (AC: 4)
  - [ ] Set up Flux controller log collection
  - [ ] Configure GitOps operation audit logging
  - [ ] Create Flux reconciliation audit trail
  - [ ] Implement change tracking and attribution
- [ ] Create security event correlation queries (AC: 5)
  - [ ] Develop KQL queries for security event detection
  - [ ] Create correlation rules for suspicious activities
  - [ ] Set up automated security incident detection
  - [ ] Configure security event dashboards
- [ ] Setup security incident alerting (AC: 5)
  - [ ] Create alerts for privilege escalation attempts
  - [ ] Configure alerts for unauthorized resource access
  - [ ] Set up alerts for policy violations
  - [ ] Create incident response automation

## Dev Notes

### Previous Story Dependencies
This story builds on:
- Story 1.15 (Comprehensive Monitoring): Log Analytics workspace and monitoring infrastructure
- All Epic 1 stories: Provides audit coverage for the complete management cluster

### Audit Logging Architecture
**Kubernetes Audit Configuration** [Source: architecture.md#operational-architecture]:
```yaml
kubernetes_audit:
  policy_file: "/etc/kubernetes/audit-policy.yaml"
  log_file: "/var/log/audit.log"
  log_maxage: 30
  log_maxbackup: 10
  log_maxsize: 100
  format: "json"

audit_levels:
  - "None"      # Don't log events that match this rule
  - "Metadata"  # Log request metadata (user, timestamp, resource, verb, etc.) but not request or response body
  - "Request"   # Log request metadata and request body but not response body
  - "RequestResponse" # Log request metadata, request and response bodies
```

**Comprehensive Audit Policy**:
```yaml
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
# Log authentication and authorization failures at Request level
- level: Request
  namespaces: [""]
  resources:
  - group: ""
    resources: ["*"]
  users: ["system:anonymous"]

# Log all requests to sensitive resources at RequestResponse level
- level: RequestResponse
  resources:
  - group: ""
    resources: ["secrets", "configmaps"]
  - group: "rbac.authorization.k8s.io"
    resources: ["*"]

# Log ASO resource operations at Request level
- level: Request
  resources:
  - group: "resources.azure.com"
    resources: ["*"]
  - group: "containerservice.azure.com"
    resources: ["*"]
  - group: "managedidentity.azure.com"
    resources: ["*"]

# Log Flux operations at Request level
- level: Request
  resources:
  - group: "source.toolkit.fluxcd.io"
    resources: ["*"]
  - group: "kustomize.toolkit.fluxcd.io"
    resources: ["*"]
  - group: "notification.toolkit.fluxcd.io"
    resources: ["*"]

# Log security-related operations at RequestResponse level
- level: RequestResponse
  resources:
  - group: "security.openshift.io"
    resources: ["*"]
  - group: "policy"
    resources: ["*"]

# Default catch-all rule - log at Metadata level
- level: Metadata
  omitStages:
  - RequestReceived
```

### Log Forwarding Configuration
**Fluent Bit Configuration for Audit Logs**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: monitoring
data:
  fluent-bit.conf: |
    [INPUT]
        Name tail
        Path /var/log/audit.log
        Tag kubernetes.audit
        Parser audit-json
        Mem_Buf_Limit 50MB

    [PARSER]
        Name audit-json
        Format json
        Time_Key timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%LZ

    [FILTER]
        Name kubernetes
        Match kubernetes.*
        Merge_Log On
        Keep_Log Off

    [OUTPUT]
        Name azure
        Match kubernetes.audit
        Customer_ID ${AZURE_LOG_ANALYTICS_CUSTOMER_ID}
        Shared_Key ${AZURE_LOG_ANALYTICS_SHARED_KEY}
        Log_Type KubernetesAudit
        Time_Generated On
```

### ASO Controller Logging
**ASO Structured Logging Configuration**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: aso-logging-config
  namespace: azure-service-operator-system
data:
  logging.yaml: |
    level: "info"
    format: "json"
    audit:
      enabled: true
      level: "debug"
      destinations:
        - "stdout"
        - "file:/var/log/aso-audit.log"

    fields:
      service: "azure-service-operator"
      version: "v2.8.0"
      cluster: "management-cluster"

    operation_tracking:
      enabled: true
      correlation_id: true
      duration_logging: true

    azure_api_logging:
      enabled: true
      include_request_body: false
      include_response_body: false
      rate_limit_logging: true
```

### Security Event Correlation
**KQL Queries for Security Events**:
```kusto
// Privilege escalation attempts
KubernetesAudit
| where TimeGenerated >= ago(1h)
| where ObjectRef_Resource == "clusterrolebindings" or ObjectRef_Resource == "rolebindings"
| where Verb == "create" or Verb == "update"
| where ResponseCode >= 200 and ResponseCode < 300
| extend UserName = tostring(User_Username)
| extend RoleName = tostring(ObjectRef_Name)
| project TimeGenerated, UserName, Verb, RoleName, SourceIPs

// Unauthorized resource access attempts
KubernetesAudit
| where TimeGenerated >= ago(1h)
| where ResponseCode >= 400 and ResponseCode < 500
| where ObjectRef_Resource in ("secrets", "configmaps")
| extend UserName = tostring(User_Username)
| extend Resource = strcat(ObjectRef_Namespace, "/", ObjectRef_Resource, "/", ObjectRef_Name)
| project TimeGenerated, UserName, Verb, Resource, ResponseCode, SourceIPs

// ASO cross-subscription operations
KubernetesAudit
| where TimeGenerated >= ago(1h)
| where ObjectRef_APIGroup contains "azure.com"
| extend UserName = tostring(User_Username)
| extend AzureResource = tostring(ObjectRef_Name)
| extend Subscription = tostring(Annotations_["serviceoperator.azure.com/subscription-id"])
| project TimeGenerated, UserName, Verb, AzureResource, Subscription, ResponseCode

// Flux reconciliation security events
KubernetesAudit
| where TimeGenerated >= ago(1h)
| where ObjectRef_APIGroup contains "toolkit.fluxcd.io"
| where Verb in ("create", "update", "delete")
| extend UserName = tostring(User_Username)
| extend FluxResource = strcat(ObjectRef_Resource, "/", ObjectRef_Name)
| project TimeGenerated, UserName, Verb, FluxResource, ObjectRef_Namespace, ResponseCode
```

### Security Incident Detection
**Automated Security Alerts**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: security-alert-rules
  namespace: monitoring
data:
  rules.yaml: |
    groups:
    - name: security-events
      rules:
      - alert: UnauthorizedSecretAccess
        expr: |
          increase(
            azure_log_analytics_query{
              query="KubernetesAudit | where ObjectRef_Resource == 'secrets' and ResponseCode >= 400"
            }[5m]
          ) > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Unauthorized secret access attempted"
          description: "Someone attempted to access secrets without proper authorization"

      - alert: PrivilegeEscalation
        expr: |
          increase(
            azure_log_analytics_query{
              query="KubernetesAudit | where ObjectRef_Resource in ('clusterrolebindings', 'rolebindings') and Verb in ('create', 'update')"
            }[10m]
          ) > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Privilege escalation detected"
          description: "Role binding changes detected - potential privilege escalation"

      - alert: SuspiciousASOActivity
        expr: |
          increase(
            azure_log_analytics_query{
              query="KubernetesAudit | where ObjectRef_APIGroup contains 'azure.com' and ResponseCode >= 400"
            }[5m]
          ) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Suspicious ASO activity detected"
          description: "High number of failed ASO operations may indicate malicious activity"
```

### Log Retention and Compliance
**Log Retention Policy**:
```yaml
log_retention:
  kubernetes_audit:
    hot_storage: "90_days"
    warm_storage: "1_year"
    cold_storage: "7_years"

  application_logs:
    hot_storage: "30_days"
    warm_storage: "6_months"
    cold_storage: "2_years"

  security_events:
    hot_storage: "180_days"
    warm_storage: "2_years"
    cold_storage: "10_years"

compliance_requirements:
  soc2:
    retention_period: "1_year"
    integrity_validation: "enabled"
    access_logging: "enabled"

  iso27001:
    retention_period: "3_years"
    encryption_at_rest: "enabled"
    access_controls: "rbac_enabled"
```

### Dashboards and Reporting
**Security Audit Dashboard**:
```json
{
  "dashboard": {
    "title": "Security Audit Dashboard",
    "panels": [
      {
        "title": "Authentication Events",
        "targets": [
          {
            "expr": "sum by (result) (rate(kubernetes_audit_total{verb='authenticate'}[5m]))",
            "legendFormat": "{{result}}"
          }
        ]
      },
      {
        "title": "Authorization Events",
        "targets": [
          {
            "expr": "sum by (result) (rate(kubernetes_audit_total{verb='authorize'}[5m]))",
            "legendFormat": "{{result}}"
          }
        ]
      },
      {
        "title": "Resource Access Patterns",
        "targets": [
          {
            "expr": "sum by (resource) (rate(kubernetes_audit_total[5m]))",
            "legendFormat": "{{resource}}"
          }
        ]
      }
    ]
  }
}
```

### File Locations
**Audit Logging Configuration Structure** [Source: folder-structure.md]:
```
eng/azureserviceoperator/managementcluster/audit/
├── kubernetes/
│   ├── audit-policy.yaml
│   └── audit-webhook-config.yaml
├── log-forwarding/
│   ├── fluent-bit-audit.yaml
│   └── log-analytics-config.yaml
├── security-queries/
│   ├── privilege-escalation.kql
│   ├── unauthorized-access.kql
│   └── suspicious-activity.kql
└── monitoring/
    ├── security-alerts.yaml
    └── audit-dashboard.json
```

## Testing

### Audit Coverage Testing
- Comprehensive audit event generation validation
- Log forwarding accuracy and completeness
- Security event detection and correlation
- Audit trail integrity and tamper detection

### Compliance Testing
- Audit log retention policy validation
- Access control and authorization logging
- Data integrity and encryption verification
- Compliance reporting functionality

### Incident Response Testing
- Security incident detection accuracy
- Alert notification delivery and escalation
- Incident response automation validation
- Forensic investigation capability testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*