# Story 2.2: Development Environment ASO Manifests

<!-- Powered by BMADâ„¢ Core -->

## Status
Draft

## Story
**As a** Platform Engineer,
**I want** to create ASO manifests for development environment,
**So that** I can provision the new cluster via GitOps.

## Acceptance Criteria
1. Development-specific variable configurations created
2. ASO manifests for dev AKS cluster created
3. Network resources manifests created
4. Identity and RBAC manifests created
5. Monitoring integration manifests created

## Tasks / Subtasks
- [ ] Create development environment variable ConfigMaps (AC: 1)
  - [ ] Create dev-specific configuration variables
  - [ ] Configure development environment naming conventions
  - [ ] Set up development resource sizing and scaling parameters
  - [ ] Create development networking configuration variables
  - [ ] Configure development-specific tags and metadata
- [ ] Create ManagedCluster manifest for development (AC: 2)
  - [ ] Create AKS cluster manifest with development specifications
  - [ ] Configure Node Auto Provisioning for development workloads
  - [ ] Set up development-appropriate node pool configurations
  - [ ] Configure development cluster networking and security
  - [ ] Add development-specific monitoring and logging integration
- [ ] Create network resource manifests (AC: 3)
  - [ ] Create VirtualNetwork manifest for development environment
  - [ ] Create subnet configurations for AKS and supporting services
  - [ ] Create NetworkSecurityGroup with development-appropriate rules
  - [ ] Set up private DNS zone for development cluster
  - [ ] Configure load balancer and ingress resources
- [ ] Create identity and RBAC manifests (AC: 4)
  - [ ] Create UserAssignedIdentity for development cluster
  - [ ] Create FederatedIdentityCredential for workload identity
  - [ ] Configure RBAC assignments for development access
  - [ ] Set up developer team access permissions
  - [ ] Create service principal configurations where needed
- [ ] Create monitoring and logging integration (AC: 5)
  - [ ] Create Log Analytics workspace for development
  - [ ] Configure Azure Monitor integration
  - [ ] Set up development-specific alerting rules
  - [ ] Create development monitoring dashboards
  - [ ] Configure log retention for development compliance
- [ ] Validate manifests with dry-run testing (AC: 1, 2, 3, 4, 5)
  - [ ] Perform kubectl dry-run validation for all manifests
  - [ ] Test variable substitution with development values
  - [ ] Validate cross-resource dependencies and references
  - [ ] Test GitOps integration with Flux
  - [ ] Verify manifest compliance with security policies

## Dev Notes

### Previous Story Dependencies
This story builds on:
- Story 2.1 (Development Migration Preparation): Environment requirements documented
- Epic 1 stories: ASO templates and variable substitution foundation established

### Development Environment Specifications
**Development Environment Configuration** [Source: architecture.md#environment-tiers]:
```yaml
development_environment:
  subscription_id: "11111111-1111-1111-1111-111111111111"
  region: "eastus"
  vnet_cidr: "10.240.0.0/16"

  cluster_specifications:
    kubernetes_version: "1.29"
    node_provisioning: "Auto"
    private_cluster: true
    workload_identity: true

  node_pools:
    system:
      vm_size: "Standard_D4s_v3"
      min_count: 1
      max_count: 3
      auto_scaling: true

    user:
      vm_size: "Standard_D4s_v3"
      min_count: 0
      max_count: 10
      auto_scaling: true

  security_profile:
    network_policy: "cilium"
    network_dataplane: "cilium"
    pod_security_standards: "restricted"
```

### Development Variable Configuration
**Development Environment Variables**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dev-environment-variables
  namespace: flux-system
data:
  # Environment identification
  ENVIRONMENT: "dev"
  WORKLOAD_TYPE: "workloads"
  INSTANCE_ID: "001"

  # Azure configuration
  AZURE_REGION: "eastus"
  SUBSCRIPTION_ID: "11111111-1111-1111-1111-111111111111"

  # Naming patterns
  CLUSTER_NAME: "dev-workloads-aks-001"
  RESOURCE_GROUP_NAME: "dev-workloads-rg-001"
  VNET_NAME: "dev-workloads-vnet-001"
  SUBNET_NAME: "dev-workloads-subnet-001"
  NSG_NAME: "dev-workloads-nsg-001"
  IDENTITY_NAME: "dev-workloads-identity-001"

  # Network configuration
  VNET_CIDR: "10.240.0.0/16"
  SUBNET_CIDR: "10.240.1.0/24"
  SERVICE_CIDR: "172.16.0.0/16"
  DNS_SERVICE_IP: "172.16.0.10"
  POD_CIDR: "10.244.0.0/16"

  # Cluster configuration
  KUBERNETES_VERSION: "1.29"
  SYSTEM_NODE_COUNT: "1"
  SYSTEM_NODE_SIZE: "Standard_D4s_v3"
  USER_NODE_MIN_COUNT: "0"
  USER_NODE_MAX_COUNT: "10"
  USER_NODE_SIZE: "Standard_D4s_v3"

  # Monitoring configuration
  LOG_ANALYTICS_WORKSPACE: "dev-workloads-law-001"
  RETENTION_DAYS: "30"

  # Tags
  COST_CENTER: "development"
  OWNER_TEAM: "platform-engineering"
  ENVIRONMENT_TYPE: "non-production"
  AUTO_SHUTDOWN: "enabled"
```

### AKS Cluster Manifest
**Development ManagedCluster**:
```yaml
apiVersion: containerservice.azure.com/v1api20240402preview
kind: ManagedCluster
metadata:
  name: ${CLUSTER_NAME}
  annotations:
    serviceoperator.azure.com/subscription-id: ${SUBSCRIPTION_ID}
spec:
  location: ${AZURE_REGION}
  owner:
    name: ${RESOURCE_GROUP_NAME}

  # Cluster identity
  identity:
    type: UserAssigned
    userAssignedIdentities:
      - reference:
          name: ${IDENTITY_NAME}

  # Kubernetes configuration
  kubernetesVersion: ${KUBERNETES_VERSION}
  dnsPrefix: ${CLUSTER_NAME}

  # Node provisioning
  nodeProvisioningProfile:
    mode: Auto

  # Network configuration
  networkProfile:
    networkPlugin: azure
    networkPluginMode: overlay
    networkPolicy: cilium
    networkDataplane: cilium
    serviceCidr: ${SERVICE_CIDR}
    dnsServiceIP: ${DNS_SERVICE_IP}
    podCidr: ${POD_CIDR}
    loadBalancerProfile:
      managedOutboundIPs:
        count: 1

  # Security configuration
  apiServerAccessProfile:
    enablePrivateCluster: true

  securityProfile:
    workloadIdentity:
      enabled: true
    imageCleaner:
      enabled: true
      intervalHours: 24

  oidcIssuerProfile:
    enabled: true

  # System node pool
  agentPoolProfiles:
    - name: system
      mode: System
      count: $((SYSTEM_NODE_COUNT))
      vmSize: ${SYSTEM_NODE_SIZE}
      osDiskSizeGB: 128
      osDiskType: Ephemeral
      osType: Linux
      enableAutoScaling: true
      minCount: 1
      maxCount: 3

      # Availability and scaling
      availabilityZones: ["1", "2", "3"]
      maxPods: 110

      # Node configuration
      nodeLabels:
        nodepool-type: "system"
        environment: ${ENVIRONMENT}
        workload-type: ${WORKLOAD_TYPE}

      nodeTaints:
        - key: "CriticalAddonsOnly"
          value: "true"
          effect: "NoSchedule"

  # Additional configuration
  autoScalerProfile:
    scaleDownDelayAfterAdd: "10m"
    scaleDownDelayAfterDelete: "10s"
    scaleDownDelayAfterFailure: "3m"
    scaleDownUnneededTime: "10m"
    scaleDownUtilizationThreshold: "0.5"
    maxGracefulTerminationSec: "600"

  # Monitoring and logging
  addonProfiles:
    omsagent:
      enabled: true
      config:
        logAnalyticsWorkspaceResourceID: "/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}/providers/microsoft.operationalinsights/workspaces/${LOG_ANALYTICS_WORKSPACE}"

  # Tags
  tags:
    environment: ${ENVIRONMENT}
    managed-by: "aso"
    cost-center: ${COST_CENTER}
    owner-team: ${OWNER_TEAM}
    environment-type: ${ENVIRONMENT_TYPE}
    auto-shutdown: ${AUTO_SHUTDOWN}
```

### User Node Pool Manifest
**Development User Node Pool**:
```yaml
apiVersion: containerservice.azure.com/v1api20240402preview
kind: ManagedClustersAgentPool
metadata:
  name: ${CLUSTER_NAME}-user
spec:
  owner:
    name: ${CLUSTER_NAME}

  # Node pool configuration
  mode: User
  count: $((USER_NODE_MIN_COUNT))
  vmSize: ${USER_NODE_SIZE}
  osDiskSizeGB: 128
  osDiskType: Ephemeral
  osType: Linux

  # Scaling configuration
  enableAutoScaling: true
  minCount: $((USER_NODE_MIN_COUNT))
  maxCount: $((USER_NODE_MAX_COUNT))

  # Availability configuration
  availabilityZones: ["1", "2", "3"]
  maxPods: 110

  # Node configuration
  nodeLabels:
    nodepool-type: "user"
    environment: ${ENVIRONMENT}
    workload-type: ${WORKLOAD_TYPE}

  # Taints for specific workloads if needed
  # nodeTaints: []

  # Tags
  tags:
    environment: ${ENVIRONMENT}
    nodepool: "user"
    auto-scaling: "enabled"
```

### Network Resources
**Development Virtual Network**:
```yaml
apiVersion: network.azure.com/v1api20201101
kind: VirtualNetwork
metadata:
  name: ${VNET_NAME}
  annotations:
    serviceoperator.azure.com/subscription-id: ${SUBSCRIPTION_ID}
spec:
  location: ${AZURE_REGION}
  owner:
    name: ${RESOURCE_GROUP_NAME}

  addressSpace:
    addressPrefixes:
      - ${VNET_CIDR}

  subnets:
    - name: ${SUBNET_NAME}
      properties:
        addressPrefix: ${SUBNET_CIDR}
        networkSecurityGroup:
          reference:
            name: ${NSG_NAME}

  tags:
    environment: ${ENVIRONMENT}
    managed-by: "aso"
    network-type: "development"
```

### Identity and RBAC
**Development User Assigned Identity**:
```yaml
apiVersion: managedidentity.azure.com/v1api20230131
kind: UserAssignedIdentity
metadata:
  name: ${IDENTITY_NAME}
  annotations:
    serviceoperator.azure.com/subscription-id: ${SUBSCRIPTION_ID}
spec:
  location: ${AZURE_REGION}
  owner:
    name: ${RESOURCE_GROUP_NAME}

  tags:
    environment: ${ENVIRONMENT}
    managed-by: "aso"
    purpose: "aks-cluster-identity"

---
apiVersion: managedidentity.azure.com/v1api20230131
kind: FederatedIdentityCredential
metadata:
  name: ${IDENTITY_NAME}-federated
spec:
  owner:
    name: ${IDENTITY_NAME}

  audiences:
    - api://AzureADTokenExchange

  issuer: # Will be set after cluster creation

  subject: system:serviceaccount:default:workload-identity-sa
```

### Monitoring Integration
**Development Log Analytics Workspace**:
```yaml
apiVersion: operationalinsights.azure.com/v1api20221001
kind: Workspace
metadata:
  name: ${LOG_ANALYTICS_WORKSPACE}
  annotations:
    serviceoperator.azure.com/subscription-id: ${SUBSCRIPTION_ID}
spec:
  location: ${AZURE_REGION}
  owner:
    name: ${RESOURCE_GROUP_NAME}

  sku:
    name: PerGB2018

  retentionInDays: $((RETENTION_DAYS))

  tags:
    environment: ${ENVIRONMENT}
    managed-by: "aso"
    purpose: "aks-monitoring"
```

### File Organization
**Development Environment Structure** [Source: folder-structure.md]:
```
eng/azureserviceoperator/overlays/development/
â”œâ”€â”€ kustomization.yaml
â”œâ”€â”€ variables/
â”‚   â”œâ”€â”€ dev-variables.yaml
â”‚   â””â”€â”€ dev-secrets.yaml
â”œâ”€â”€ foundation/
â”‚   â”œâ”€â”€ resource-group.yaml
â”‚   â””â”€â”€ kustomization.yaml
â”œâ”€â”€ identity/
â”‚   â”œâ”€â”€ user-assigned-identity.yaml
â”‚   â”œâ”€â”€ federated-identity-credential.yaml
â”‚   â””â”€â”€ kustomization.yaml
â”œâ”€â”€ network/
â”‚   â”œâ”€â”€ virtual-network.yaml
â”‚   â”œâ”€â”€ network-security-group.yaml
â”‚   â””â”€â”€ kustomization.yaml
â”œâ”€â”€ cluster/
â”‚   â”œâ”€â”€ managed-cluster.yaml
â”‚   â”œâ”€â”€ user-node-pool.yaml
â”‚   â””â”€â”€ kustomization.yaml
â””â”€â”€ monitoring/
    â”œâ”€â”€ log-analytics-workspace.yaml
    â””â”€â”€ kustomization.yaml
```

## Testing

### Manifest Validation Testing
- ASO CRD schema compliance validation
- Variable substitution accuracy testing
- Cross-resource dependency verification
- Kubernetes API dry-run testing

### GitOps Integration Testing
- Flux synchronization with development manifests
- Variable substitution during deployment
- Resource creation order and dependencies
- Error handling and retry mechanisms

### Environment Specific Testing
- Development resource sizing validation
- Network configuration testing
- Security policy compliance verification
- Monitoring and logging integration validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*