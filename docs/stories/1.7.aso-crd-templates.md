# Story 1.7: ASO CRD Templates Creation

<!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** Platform Engineer,
**I want** to create standardized ASO CRD templates,
**So that** I can consistently provision Azure resources.

## Acceptance Criteria
1. ResourceGroup CRD template created
2. ManagedCluster CRD template created
3. UserAssignedIdentity CRD template created
4. VirtualNetwork CRD template created
5. Templates include variable placeholders
6. Templates validated with dry-run testing

## Tasks / Subtasks
- [ ] Analyze current ARM template structure (AC: 1, 2, 3, 4)
  - [ ] Review existing ARM template configurations
  - [ ] Map ARM resources to ASO CRD equivalents
  - [ ] Identify common configuration patterns
  - [ ] Document resource dependencies and relationships
- [ ] Create ResourceGroup CRD template (AC: 1, 5)
  - [ ] Create base ResourceGroup template with variable substitution
  - [ ] Include environment-specific naming patterns
  - [ ] Add mandatory tags for governance
  - [ ] Configure subscription targeting
- [ ] Create ManagedCluster CRD template with NAP (AC: 2, 5)
  - [ ] Create AKS cluster template with Node Auto Provisioning
  - [ ] Configure private cluster with no public endpoints
  - [ ] Set up workload identity and OIDC issuer
  - [ ] Configure Azure CNI with overlay networking
  - [ ] Include Cilium network policy configuration
- [ ] Create identity and network CRD templates (AC: 3, 4, 5)
  - [ ] Create UserAssignedIdentity template
  - [ ] Create FederatedIdentityCredential template
  - [ ] Create VirtualNetwork template with subnets
  - [ ] Create NetworkSecurityGroup template
- [ ] Add variable substitution placeholders (AC: 5)
  - [ ] Define standard variable naming conventions
  - [ ] Create environment-specific variable maps
  - [ ] Implement resource reference patterns
  - [ ] Document variable usage and examples
- [ ] Validate templates with kubectl dry-run (AC: 6)
  - [ ] Perform dry-run validation for all templates
  - [ ] Test variable substitution mechanisms
  - [ ] Validate CRD schema compliance
  - [ ] Test template composition and dependencies

## Dev Notes

### Previous Story Dependencies
This story builds on:
- Story 1.5 (ASO Installation): ASO CRDs must be available
- Story 1.6 (Multi-Subscription Config): Subscription targeting patterns established

### ARM to ASO Mapping
**Current ARM Template Analysis** [Source: architecture.md#current-arm-template-analysis]:
```json
{
  "type": "Microsoft.ContainerService/managedClusters",
  "apiVersion": "2025-05-02-preview",
  "properties": {
    "nodeProvisioningProfile": {
      "mode": "Auto"
    },
    "networkProfile": {
      "networkPlugin": "azure",
      "networkPolicy": "cilium",
      "networkDataplane": "cilium"
    },
    "securityProfile": {
      "workloadIdentity": {
        "enabled": true
      }
    }
  }
}
```

**ASO CRD Equivalent**:
```yaml
apiVersion: containerservice.azure.com/v1api20240402preview
kind: ManagedCluster
metadata:
  name: ${CLUSTER_NAME}
spec:
  location: ${AZURE_REGION}
  owner:
    name: ${RESOURCE_GROUP}
  nodeProvisioningProfile:
    mode: Auto
  networkProfile:
    networkPlugin: azure
    networkPluginMode: overlay
    networkPolicy: cilium
    networkDataplane: cilium
  securityProfile:
    workloadIdentity:
      enabled: true
  oidcIssuerProfile:
    enabled: true
```

### Template Structure
**ResourceGroup Template**:
```yaml
apiVersion: resources.azure.com/v1api20200601
kind: ResourceGroup
metadata:
  name: ${ENVIRONMENT}-${WORKLOAD}-rg-${INSTANCE}
  annotations:
    serviceoperator.azure.com/subscription-id: ${SUBSCRIPTION_ID}
spec:
  location: ${AZURE_REGION}
  tags:
    environment: ${ENVIRONMENT}
    managed-by: "aso"
    cost-center: ${COST_CENTER}
    owner: ${OWNER_TEAM}
```

**VirtualNetwork Template**:
```yaml
apiVersion: network.azure.com/v1api20201101
kind: VirtualNetwork
metadata:
  name: ${ENVIRONMENT}-${WORKLOAD}-vnet-${INSTANCE}
spec:
  location: ${AZURE_REGION}
  owner:
    name: ${RESOURCE_GROUP}
  addressSpace:
    addressPrefixes:
      - ${VNET_CIDR}
  subnets:
    - name: ${SUBNET_NAME}
      properties:
        addressPrefix: ${SUBNET_CIDR}
        networkSecurityGroup:
          reference:
            name: ${NSG_NAME}
```

### Variable Substitution Patterns
**Standard Variables** [Source: architecture.md#technology-stack]:
```yaml
variables:
  common:
    AZURE_REGION: "eastus"
    SUBSCRIPTION_ID: "configurable-per-environment"
    COST_CENTER: "platform-engineering"
    OWNER_TEAM: "platform-team"

  environment_specific:
    ENVIRONMENT: "dev|stg|prod"
    WORKLOAD: "workloads|management|shared"
    INSTANCE: "001|002|003"

  network_specific:
    VNET_CIDR: "environment-specific-cidr"
    SUBNET_CIDR: "subnet-specific-cidr"
    CLUSTER_SUBNET: "aks-subnet-name"

  cluster_specific:
    CLUSTER_NAME: "${ENVIRONMENT}-${WORKLOAD}-aks-${INSTANCE}"
    NODE_RESOURCE_GROUP: "${CLUSTER_NAME}-nodes-rg"
    KUBERNETES_VERSION: "1.29"
```

### ASO Resource Dependencies
**Resource Creation Order** [Source: architecture.md#azure-service-operator-resource-hierarchy]:
1. ResourceGroup (foundation)
2. UserAssignedIdentity (for workload identity)
3. VirtualNetwork and subnets (networking)
4. NetworkSecurityGroup (security)
5. ManagedCluster (with dependencies)
6. FederatedIdentityCredential (workload identity)

### Template Validation
**Dry-Run Testing**:
```bash
# Validate CRD syntax and schema
kubectl apply --dry-run=server -f resource-group-template.yaml

# Test with variable substitution
envsubst < managedcluster-template.yaml | kubectl apply --dry-run=server -f -

# Validate cross-resource references
kubectl apply --dry-run=server -f complete-environment/
```

### File Locations
**Template Organization** [Source: folder-structure.md]:
```
eng/azureserviceoperator/
├── base/
│   ├── templates/
│   │   ├── resource-group.yaml
│   │   ├── managed-cluster.yaml
│   │   ├── user-assigned-identity.yaml
│   │   ├── virtual-network.yaml
│   │   └── network-security-group.yaml
│   └── kustomization.yaml
└── overlays/
    ├── development/
    ├── staging/
    └── production/
```

## Testing

### Template Validation
- CRD schema compliance testing
- Variable substitution accuracy testing
- Resource reference validation
- Kubernetes API dry-run testing
- Template composition testing

### Integration Testing
- End-to-end resource provisioning testing
- Cross-resource dependency validation
- Error handling and rollback testing
- Performance testing with multiple resources

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*