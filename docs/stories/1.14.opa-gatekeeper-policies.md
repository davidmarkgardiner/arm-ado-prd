# Story 1.14: OPA Gatekeeper Security Policies

<!-- Powered by BMADâ„¢ Core -->

## Status
Draft

## Story
**As a** Security Engineer,
**I want** to deploy OPA Gatekeeper with security policies,
**So that** I can enforce organizational security requirements.

## Acceptance Criteria
1. OPA Gatekeeper installed and operational
2. Required labels policy implemented
3. Resource limit policies implemented
4. Image security policies implemented
5. Policy violations monitored and alerted

## Tasks / Subtasks
- [ ] Install OPA Gatekeeper using Helm (AC: 1)
  - [ ] Install Gatekeeper v3.14+ using Helm chart
  - [ ] Configure Gatekeeper system resources and limits
  - [ ] Verify admission webhook registration
  - [ ] Test basic policy enforcement capability
- [ ] Create constraint templates for required policies (AC: 2, 3, 4)
  - [ ] Create ConstraintTemplate for required labels
  - [ ] Create ConstraintTemplate for resource limits
  - [ ] Create ConstraintTemplate for image security
  - [ ] Create ConstraintTemplate for network policies
- [ ] Implement required labels constraint (AC: 2)
  - [ ] Create K8sRequiredLabels constraint
  - [ ] Define mandatory labels for all resources
  - [ ] Configure label validation rules
  - [ ] Test label enforcement across namespaces
- [ ] Create resource limits and quotas constraints (AC: 3)
  - [ ] Implement K8sContainerLimits constraint
  - [ ] Create K8sResourceQuota constraint
  - [ ] Configure memory and CPU limit requirements
  - [ ] Test resource limit enforcement
- [ ] Implement image scanning requirements (AC: 4)
  - [ ] Create K8sAllowedRepos constraint
  - [ ] Configure trusted container registry policies
  - [ ] Implement image tag and digest requirements
  - [ ] Test image security policy enforcement
- [ ] Setup policy violation alerting (AC: 5)
  - [ ] Configure Prometheus metrics collection
  - [ ] Create alerts for policy violations
  - [ ] Set up notification channels
  - [ ] Create policy violation dashboards

## Dev Notes

### Previous Story Dependencies
This story builds on:
- Story 1.13 (Pod Security Standards): Establishes baseline security policies
- Story 1.1 (Management Cluster): Provides the Kubernetes cluster

### OPA Gatekeeper Architecture
**Gatekeeper Configuration** [Source: architecture.md#security-stack]:
```yaml
opa_gatekeeper:
  version: "v3.14+"
  policies:
    - "pod_security_standards"
    - "network_policies"
    - "resource_quotas"
    - "image_scanning_requirements"

azure_policy:
  kubernetes_integration: true
  compliance_frameworks:
    - "cis_benchmark"
    - "nist_800_53"
    - "pci_dss"
```

**Helm Installation Configuration**:
```bash
helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
helm install gatekeeper gatekeeper/gatekeeper \
  --namespace gatekeeper-system \
  --create-namespace \
  --set replicas=3 \
  --set resources.requests.cpu=100m \
  --set resources.requests.memory=256Mi \
  --set resources.limits.cpu=1000m \
  --set resources.limits.memory=512Mi
```

### Constraint Templates
**Required Labels ConstraintTemplate**:
```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        openAPIV3Schema:
          type: object
          properties:
            labels:
              type: array
              items:
                type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels

        violation[{"msg": msg}] {
          required := input.parameters.labels
          provided := input.review.object.metadata.labels
          missing := required[_]
          not provided[missing]
          msg := sprintf("Missing required label: %v", [missing])
        }
```

**Resource Limits ConstraintTemplate**:
```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8scontainerlimits
spec:
  crd:
    spec:
      names:
        kind: K8sContainerLimits
      validation:
        openAPIV3Schema:
          type: object
          properties:
            cpu:
              type: string
            memory:
              type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8scontainerlimits

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits.cpu
          msg := "CPU limit must be specified"
        }

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.resources.limits.memory
          msg := "Memory limit must be specified"
        }
```

### Policy Constraints
**Required Labels Policy**:
```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: must-have-environment
spec:
  match:
    kinds:
      - apiGroups: ["apps"]
        kinds: ["Deployment", "StatefulSet", "DaemonSet"]
      - apiGroups: [""]
        kinds: ["Pod", "Service"]
    excludedNamespaces:
      - "kube-system"
      - "gatekeeper-system"
      - "flux-system"
  parameters:
    labels:
      - "environment"
      - "managed-by"
      - "cost-center"
```

**Container Resource Limits Policy**:
```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sContainerLimits
metadata:
  name: container-must-have-limits
spec:
  match:
    kinds:
      - apiGroups: ["apps"]
        kinds: ["Deployment", "StatefulSet", "DaemonSet"]
      - apiGroups: [""]
        kinds: ["Pod"]
    excludedNamespaces:
      - "kube-system"
      - "gatekeeper-system"
  parameters:
    cpu: "required"
    memory: "required"
```

**Allowed Container Registries Policy**:
```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sallowedrepos
spec:
  crd:
    spec:
      names:
        kind: K8sAllowedRepos
      validation:
        openAPIV3Schema:
          type: object
          properties:
            repos:
              type: array
              items:
                type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8sallowedrepos

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          image := container.image
          not starts_with(image, input.parameters.repos[_])
          msg := sprintf("Image '%v' not from approved registry", [image])
        }

---
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
  name: allowed-docker-registries
spec:
  match:
    kinds:
      - apiGroups: ["apps"]
        kinds: ["Deployment", "StatefulSet", "DaemonSet"]
      - apiGroups: [""]
        kinds: ["Pod"]
  parameters:
    repos:
      - "mcr.microsoft.com"
      - "registry.company.com"
      - "quay.io/company"
```

### Monitoring and Alerting
**Gatekeeper Metrics and Alerts**:
```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: gatekeeper-policy-alerts
  namespace: monitoring
spec:
  groups:
  - name: gatekeeper-policies
    rules:
    - alert: GatekeeperPolicyViolation
      expr: increase(gatekeeper_violations_total[5m]) > 0
      for: 0m
      labels:
        severity: warning
      annotations:
        summary: "Gatekeeper policy violation detected"
        description: "Policy {{ $labels.violation_kind }} has been violated {{ $value }} times in the last 5 minutes"

    - alert: GatekeeperWebhookDown
      expr: up{job="gatekeeper-webhook"} == 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "Gatekeeper webhook is down"
        description: "Gatekeeper admission webhook has been down for more than 2 minutes"

    - alert: HighPolicyViolationRate
      expr: rate(gatekeeper_violations_total[10m]) > 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High policy violation rate detected"
        description: "Policy violation rate is {{ $value }} violations per second over the last 10 minutes"
```

### Policy Testing and Validation
**Policy Testing Framework**:
```bash
#!/bin/bash
# test-gatekeeper-policies.sh

echo "Testing Gatekeeper policy enforcement..."

# Test 1: Required labels policy
echo "Testing required labels policy..."
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-no-labels
  namespace: applications
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test
  template:
    metadata:
      labels:
        app: test
    spec:
      containers:
      - name: test
        image: nginx:alpine
EOF

# Test 2: Resource limits policy
echo "Testing resource limits policy..."
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-no-limits
  namespace: applications
  labels:
    environment: "test"
    managed-by: "gatekeeper-test"
    cost-center: "platform"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test-limits
  template:
    metadata:
      labels:
        app: test-limits
    spec:
      containers:
      - name: test
        image: nginx:alpine
        # Missing resource limits - should be rejected
EOF

# Test 3: Allowed repos policy
echo "Testing allowed repositories policy..."
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-bad-repo
  namespace: applications
  labels:
    environment: "test"
    managed-by: "gatekeeper-test"
    cost-center: "platform"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test-repo
  template:
    metadata:
      labels:
        app: test-repo
    spec:
      containers:
      - name: test
        image: docker.io/nginx:alpine  # Unauthorized registry
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
EOF

echo "Policy testing completed"
```

### File Locations
**Gatekeeper Configuration Structure** [Source: folder-structure.md]:
```
eng/azureserviceoperator/managementcluster/security/
â”œâ”€â”€ gatekeeper/
â”‚   â”œâ”€â”€ constraint-templates/
â”‚   â”‚   â”œâ”€â”€ required-labels.yaml
â”‚   â”‚   â”œâ”€â”€ resource-limits.yaml
â”‚   â”‚   â”œâ”€â”€ allowed-repos.yaml
â”‚   â”‚   â””â”€â”€ network-policies.yaml
â”‚   â”œâ”€â”€ constraints/
â”‚   â”‚   â”œâ”€â”€ production-labels.yaml
â”‚   â”‚   â”œâ”€â”€ container-limits.yaml
â”‚   â”‚   â””â”€â”€ registry-allowlist.yaml
â”‚   â””â”€â”€ monitoring/
â”‚       â”œâ”€â”€ alerts.yaml
â”‚       â””â”€â”€ dashboards.yaml
```

## Testing

### Policy Enforcement Testing
- Required labels policy validation
- Resource limits enforcement testing
- Image security policy verification
- Network policy constraint testing

### Violation Monitoring Testing
- Policy violation detection and alerting
- Metrics collection accuracy validation
- Dashboard functionality verification
- Notification delivery testing

### Performance Impact Testing
- Admission webhook latency measurement
- Resource utilization monitoring
- Concurrent request handling validation
- Scaling behavior under load

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*