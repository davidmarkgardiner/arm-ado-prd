# Story 1.10: Flux Post-Build Variable Substitution

<!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** Platform Engineer,
**I want** to implement variable substitution in Flux,
**So that** I can use the same templates across environments.

## Acceptance Criteria
1. ConfigMaps created for non-sensitive variables
2. Kubernetes Secrets created for sensitive variables
3. Flux Kustomization with substituteFrom configured
4. Variable substitution working correctly
5. Environment-specific overlays created

## Tasks / Subtasks
- [ ] Create base ConfigMap templates for variables (AC: 1)
  - [ ] Design variable naming conventions
  - [ ] Create ConfigMaps for environment-specific values
  - [ ] Include subscription IDs, region names, and resource naming
  - [ ] Document variable usage patterns
- [ ] Create Kubernetes Secrets for sensitive data (AC: 2)
  - [ ] Create secrets for SSH keys and API tokens
  - [ ] Use Azure Key Vault integration where appropriate
  - [ ] Implement secret rotation procedures
  - [ ] Document secret management policies
- [ ] Configure Flux Kustomization with post-build substitution (AC: 3)
  - [ ] Update Kustomization to include substituteFrom
  - [ ] Configure variable substitution from ConfigMaps
  - [ ] Configure variable substitution from Secrets
  - [ ] Test variable resolution and error handling
- [ ] Create environment-specific variable overlays (AC: 4, 5)
  - [ ] Create development environment variables
  - [ ] Create staging environment variables
  - [ ] Create production environment variables
  - [ ] Test variable substitution across all environments
- [ ] Test variable substitution with sample resources (AC: 4)
  - [ ] Create test resources with variable placeholders
  - [ ] Validate substitution accuracy and completeness
  - [ ] Test edge cases and error scenarios
  - [ ] Verify no variable leakage between environments
- [ ] Document variable management procedures (AC: 1, 2, 5)
  - [ ] Create variable management documentation
  - [ ] Document security considerations for sensitive variables
  - [ ] Create troubleshooting guide for substitution issues
  - [ ] Document variable validation procedures

## Dev Notes

### Previous Story Dependencies
This story builds on:
- Story 1.9 (Flux Installation): Flux must be installed and operational
- Story 1.7 (ASO CRD Templates): Templates need variable placeholders

### Variable Substitution Architecture
**Flux Post-Build Substitution** [Source: architecture.md#flux-configuration]:
```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infrastructure-dev
  namespace: flux-system
spec:
  interval: 10m
  path: "./environments/development"
  prune: true
  sourceRef:
    kind: GitRepository
    name: infrastructure
  postBuild:
    substitute:
      ENVIRONMENT: "dev"
      AZURE_REGION: "eastus"
    substituteFrom:
      - kind: ConfigMap
        name: environment-variables
      - kind: Secret
        name: sensitive-variables
```

### Variable Categories
**Non-Sensitive Variables (ConfigMaps)**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: environment-variables
  namespace: flux-system
data:
  # Environment identification
  ENVIRONMENT: "dev"
  WORKLOAD_TYPE: "workloads"
  INSTANCE_ID: "001"

  # Azure configuration
  AZURE_REGION: "eastus"
  SUBSCRIPTION_ID: "11111111-1111-1111-1111-111111111111"
  RESOURCE_GROUP_SUFFIX: "rg"

  # Network configuration
  VNET_CIDR: "10.240.0.0/16"
  SUBNET_CIDR: "10.240.1.0/24"

  # Cluster configuration
  KUBERNETES_VERSION: "1.29"
  NODE_COUNT: "3"
  NODE_SIZE: "Standard_D4s_v3"

  # Monitoring configuration
  LOG_ANALYTICS_WORKSPACE: "dev-monitoring-law-001"

  # Naming patterns
  CLUSTER_NAME: "${ENVIRONMENT}-${WORKLOAD_TYPE}-aks-${INSTANCE_ID}"
  RESOURCE_GROUP_NAME: "${ENVIRONMENT}-${WORKLOAD_TYPE}-${RESOURCE_GROUP_SUFFIX}-${INSTANCE_ID}"
```

**Sensitive Variables (Secrets)**:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: sensitive-variables
  namespace: flux-system
type: Opaque
stringData:
  # Authentication
  AZURE_CLIENT_ID: "application-client-id"
  SSH_PUBLIC_KEY: "ssh-rsa AAAAB3NzaC1yc2E..."

  # External integrations
  SLACK_WEBHOOK_URL: "https://hooks.slack.com/..."
  NOTIFICATION_EMAIL: "platform-alerts@company.com"
```

### Environment-Specific Overlays
**Development Environment Variables**:
```yaml
# environments/development/variables.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dev-variables
  namespace: flux-system
data:
  ENVIRONMENT: "dev"
  SUBSCRIPTION_ID: "${DEV_SUBSCRIPTION_ID}"
  VNET_CIDR: "10.240.0.0/16"
  NODE_COUNT: "1"
  NODE_SIZE: "Standard_B2ms"
  AUTO_SCALING_ENABLED: "true"
  MAX_NODE_COUNT: "5"
```

**Production Environment Variables**:
```yaml
# environments/production/variables.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prod-variables
  namespace: flux-system
data:
  ENVIRONMENT: "prod"
  SUBSCRIPTION_ID: "${PROD_SUBSCRIPTION_ID}"
  VNET_CIDR: "10.242.0.0/16"
  NODE_COUNT: "3"
  NODE_SIZE: "Standard_D8s_v5"
  AUTO_SCALING_ENABLED: "true"
  MAX_NODE_COUNT: "50"
  AVAILABILITY_ZONES: '["1","2","3"]'
```

### Template with Variable Substitution
**Example Template Usage**:
```yaml
apiVersion: containerservice.azure.com/v1api20240402preview
kind: ManagedCluster
metadata:
  name: ${CLUSTER_NAME}
  annotations:
    serviceoperator.azure.com/subscription-id: ${SUBSCRIPTION_ID}
spec:
  location: ${AZURE_REGION}
  owner:
    name: ${RESOURCE_GROUP_NAME}
  kubernetesVersion: ${KUBERNETES_VERSION}
  agentPoolProfiles:
    - name: system
      count: $((NODE_COUNT))
      vmSize: ${NODE_SIZE}
      availabilityZones: ${AVAILABILITY_ZONES}
      enableAutoScaling: $((AUTO_SCALING_ENABLED))
      maxCount: $((MAX_NODE_COUNT))
  networkProfile:
    networkPlugin: azure
    networkPluginMode: overlay
    serviceCidr: 172.16.0.0/16
    dnsServiceIP: 172.16.0.10
```

### Variable Validation
**Substitution Validation Script**:
```bash
#!/bin/bash
# validate-substitution.sh

echo "Validating Flux variable substitution..."

# Check ConfigMap existence
kubectl get configmap environment-variables -n flux-system || exit 1

# Check Secret existence
kubectl get secret sensitive-variables -n flux-system || exit 1

# Test dry-run with substitution
flux build kustomization infrastructure-dev \
  --path ./environments/development \
  --dry-run > /tmp/substituted-manifests.yaml

# Validate no unresolved variables
if grep -q '\${' /tmp/substituted-manifests.yaml; then
  echo "ERROR: Unresolved variables found:"
  grep '\${' /tmp/substituted-manifests.yaml
  exit 1
fi

echo "Variable substitution validation passed"
```

### Security Considerations
**Variable Security Patterns**:
- Non-sensitive data in ConfigMaps for transparency
- Sensitive data in Kubernetes Secrets
- Integration with Azure Key Vault for external secrets
- Variable scoping to prevent cross-environment leakage
- Audit logging for variable access and changes

### File Locations
**Variable Management Structure** [Source: folder-structure.md]:
```
eng/azureserviceoperator/
├── base/
│   ├── configmap/
│   │   ├── common-variables.yaml
│   │   └── naming-conventions.yaml
│   └── secrets/
│       └── sensitive-variables.yaml
└── overlays/
    ├── development/
    │   ├── dev-variables.yaml
    │   └── kustomization.yaml
    ├── staging/
    │   ├── stg-variables.yaml
    │   └── kustomization.yaml
    └── production/
        ├── prod-variables.yaml
        └── kustomization.yaml
```

## Testing

### Substitution Accuracy Testing
- Variable resolution completeness validation
- Environment-specific variable isolation testing
- Sensitive data handling and security testing
- Edge case handling (missing variables, malformed syntax)

### Integration Testing
- End-to-end GitOps workflow with substitution
- Multi-environment deployment consistency
- Variable precedence and override testing
- Error handling and rollback scenario testing

### Security Testing
- Variable leakage prevention testing
- Secret access control validation
- Audit logging verification
- Cross-environment contamination prevention

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*