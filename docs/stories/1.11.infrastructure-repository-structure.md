# Story 1.11: Infrastructure Repository Structure Creation

<!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** Platform Engineer,
**I want** to create a proper Git repository structure,
**So that** I can organize infrastructure code effectively.

## Acceptance Criteria
1. Repository structure following GitOps best practices
2. Base manifests and overlays separated
3. Environment-specific configurations organized
4. README and documentation created
5. Branch protection rules configured

## Tasks / Subtasks
- [ ] Design repository structure for infrastructure code (AC: 1, 2, 3)
  - [ ] Create GitOps-compliant directory structure
  - [ ] Separate base manifests from environment overlays
  - [ ] Organize by component and environment
  - [ ] Follow Kustomize best practices
- [ ] Create base manifests directory structure (AC: 1, 2)
  - [ ] Create base ASO templates and CRDs
  - [ ] Organize by resource type and functionality
  - [ ] Include shared configuration templates
  - [ ] Create base kustomization files
- [ ] Create environment-specific overlay directories (AC: 2, 3)
  - [ ] Create development environment overlay
  - [ ] Create staging environment overlay
  - [ ] Create production environment overlay
  - [ ] Include environment-specific variables and patches
- [ ] Setup branch protection rules in Git repository (AC: 5)
  - [ ] Configure main branch protection
  - [ ] Require pull request reviews
  - [ ] Enable status checks before merge
  - [ ] Configure deployment branch policies
- [ ] Create comprehensive README documentation (AC: 4)
  - [ ] Document repository structure and conventions
  - [ ] Create contribution guidelines
  - [ ] Document GitOps workflow procedures
  - [ ] Include troubleshooting and maintenance guides
- [ ] Initialize repository with sample manifests (AC: 1, 2, 3)
  - [ ] Add sample base manifests
  - [ ] Include example environment overlays
  - [ ] Test repository structure with Flux
  - [ ] Validate all paths and references

## Dev Notes

### Repository Structure Design
**GitOps Repository Layout** [Source: architecture.md#infrastructure-repository-structure]:
```
infrastructure/
├── README.md
├── .gitignore
├── clusters/
│   └── management/
│       ├── flux-system/
│       │   ├── gotk-components.yaml
│       │   ├── gotk-sync.yaml
│       │   └── kustomization.yaml
│       └── infrastructure/
│           ├── kustomization.yaml
│           └── sources/
├── platform/
│   └── azure-service-operator/
│       ├── base/
│       │   ├── configmap/
│       │   ├── cluster/
│       │   ├── identity/
│       │   ├── monitoring/
│       │   └── kustomization.yaml
│       └── overlays/
│           ├── development/
│           ├── staging/
│           └── production/
├── environments/
│   ├── development/
│   │   ├── infrastructure/
│   │   │   ├── kustomization.yaml
│   │   │   └── variables.yaml
│   │   └── applications/
│   ├── staging/
│   └── production/
└── docs/
    ├── architecture/
    ├── runbooks/
    └── troubleshooting/
```

### Base Manifests Structure
**Base Platform Components** [Source: folder-structure.md]:
```yaml
platform/azure-service-operator/base/:
  configmap/:
    - common-variables.yaml      # Common configuration values
    - naming-conventions.yaml    # Resource naming patterns
    - subscription-mapping.yaml  # Subscription ID mappings

  cluster/:
    - managed-cluster.yaml       # AKS cluster base template
    - node-pools.yaml           # Node pool configurations
    - maintenance-config.yaml   # Maintenance window settings

  identity/:
    - user-assigned-identity.yaml       # UAMI base template
    - federated-identity-credential.yaml # Workload identity config
    - rbac-assignments.yaml             # RBAC role assignments

  monitoring/:
    - log-analytics-workspace.yaml  # Monitoring workspace
    - data-collection-rules.yaml    # DCR configurations
    - prometheus-rules.yaml         # Prometheus rule groups
    - action-groups.yaml           # Alert action groups

  kustomization.yaml:
    resources:
      - configmap
      - cluster
      - identity
      - monitoring
```

### Environment Overlays
**Development Environment Overlay**:
```yaml
# environments/development/infrastructure/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: azure-service-operator-system

resources:
  - ../../../platform/azure-service-operator/base

patchesStrategicMerge:
  - patches/dev-cluster-patch.yaml
  - patches/dev-monitoring-patch.yaml

configMapGenerator:
  - name: dev-variables
    files:
      - variables.yaml

replacements:
  - source:
      kind: ConfigMap
      name: dev-variables
      fieldPath: data.CLUSTER_NAME
    targets:
      - select:
          kind: ManagedCluster
        fieldPaths:
          - metadata.name
```

**Environment-Specific Patches**:
```yaml
# environments/development/infrastructure/patches/dev-cluster-patch.yaml
apiVersion: containerservice.azure.com/v1api20240402preview
kind: ManagedCluster
metadata:
  name: dev-cluster
spec:
  agentPoolProfiles:
    - name: system
      count: 1
      vmSize: Standard_B2ms
      enableAutoScaling: true
      minCount: 1
      maxCount: 3
```

### Branch Protection Configuration
**Repository Protection Rules**:
```yaml
branch_protection:
  main:
    required_reviews: 2
    dismiss_stale_reviews: true
    require_code_owner_reviews: true
    required_status_checks:
      - "flux/kustomization-validation"
      - "security/policy-validation"
      - "docs/link-validation"
    enforce_admins: true
    restrictions:
      users: []
      teams: ["platform-team"]

  deployment_branches:
    pattern: "deploy/*"
    required_reviews: 1
    auto_merge_enabled: false
```

### Documentation Standards
**Repository Documentation Structure**:
```markdown
# Infrastructure Repository

## Overview
This repository contains the infrastructure-as-code for our Azure Service Operator deployment using GitOps with Flux.

## Repository Structure
- `clusters/`: Flux bootstrap and cluster configuration
- `platform/`: Base platform components and templates
- `environments/`: Environment-specific overlays and configurations
- `docs/`: Documentation and runbooks

## Getting Started
1. Clone the repository
2. Review environment configurations
3. Follow contribution guidelines
4. Test changes in development first

## GitOps Workflow
1. Create feature branch
2. Make infrastructure changes
3. Test with Flux dry-run
4. Create pull request
5. Review and merge
6. Monitor deployment

## Contributing
- Follow naming conventions
- Include proper documentation
- Test all changes
- Update relevant documentation
```

### Validation and Testing
**Repository Validation Scripts**:
```bash
#!/bin/bash
# validate-repository-structure.sh

echo "Validating repository structure..."

# Check required directories
required_dirs=(
  "clusters/management"
  "platform/azure-service-operator/base"
  "environments/development"
  "environments/staging"
  "environments/production"
)

for dir in "${required_dirs[@]}"; do
  if [ ! -d "$dir" ]; then
    echo "ERROR: Missing required directory: $dir"
    exit 1
  fi
done

# Check required files
required_files=(
  "README.md"
  "clusters/management/flux-system/kustomization.yaml"
  "platform/azure-service-operator/base/kustomization.yaml"
)

for file in "${required_files[@]}"; do
  if [ ! -f "$file" ]; then
    echo "ERROR: Missing required file: $file"
    exit 1
  fi
done

# Validate kustomization files
echo "Validating kustomization files..."
find . -name "kustomization.yaml" -exec kubectl kustomize {} \; > /dev/null

echo "Repository structure validation passed"
```

### Integration with Flux
**Root Kustomization Configuration**:
```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: platform-infrastructure
  namespace: flux-system
spec:
  interval: 10m
  path: "./platform"
  prune: true
  sourceRef:
    kind: GitRepository
    name: infrastructure
  validation: client
  healthChecks:
    - apiVersion: apps/v1
      kind: Deployment
      name: azure-service-operator-controller-manager
      namespace: azure-service-operator-system
```

## Testing

### Structure Validation
- Directory structure compliance testing
- Kustomization file syntax validation
- Reference and path accuracy verification
- Branch protection rule enforcement testing

### GitOps Integration Testing
- Flux repository synchronization validation
- Kustomization build and apply testing
- Environment isolation verification
- Change detection and reconciliation testing

### Documentation Testing
- Link validation and accuracy
- Documentation completeness verification
- Contribution workflow testing
- README clarity and usability validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*