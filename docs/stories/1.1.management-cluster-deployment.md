# Story 1.1: Management Cluster Deployment

<!-- Powered by BMADâ„¢ Core -->

## Status
Draft

## Story
**As a** Platform Engineering Team,
**I want** to deploy a dedicated management cluster for orchestration,
**so that** we can centrally manage Azure Service Operator and GitOps workflows across multiple environments and subscriptions.

## Acceptance Criteria
1. Management cluster deployed in dedicated subscription
2. Private cluster configuration with bastion host access
3. Azure RBAC integration with AAD
4. Workload identity enabled
5. Comprehensive monitoring and logging

## Tasks / Subtasks
- [ ] Deploy management cluster subscription and resource group (AC: 1)
  - [ ] Create dedicated management subscription if needed
  - [ ] Create management cluster resource group
  - [ ] Configure subscription-level RBAC for management operations
- [ ] Provision network infrastructure for private cluster (AC: 2)
  - [ ] Create Management VNet (10.250.0.0/16)
  - [ ] Create Bastion subnet (10.250.1.0/24)
  - [ ] Create Management cluster subnet (10.250.2.0/24)
  - [ ] Deploy Azure Bastion host for secure access
  - [ ] Configure Network Security Groups with minimal required access
- [ ] Deploy Azure Kubernetes Service management cluster (AC: 1, 2, 4)
  - [ ] Deploy AKS with latest API version (2025-05-02-preview)
  - [ ] Configure private cluster with no public API endpoints
  - [ ] Enable Node Auto Provisioning (NAP) for cost optimization
  - [ ] Configure Azure CNI with overlay networking
  - [ ] Enable workload identity and OIDC issuer
  - [ ] Set up Cilium for network policy and data plane
- [ ] Configure Azure RBAC and identity integration (AC: 3, 4)
  - [ ] Integrate cluster with Azure Active Directory
  - [ ] Create User Assigned Managed Identity for cross-subscription access
  - [ ] Configure custom RBAC roles following principle of least privilege
  - [ ] Set up federated identity credentials for workload identity
  - [ ] Test cross-subscription resource provider registration
- [ ] Implement monitoring and logging infrastructure (AC: 5)
  - [ ] Deploy Log Analytics workspace
  - [ ] Configure Azure Monitor for containers
  - [ ] Set up Prometheus and Grafana integration
  - [ ] Configure kubernetes audit logging
  - [ ] Implement comprehensive alerting for cluster health
- [ ] Validate cluster deployment and access (AC: 1, 2, 3, 4, 5)
  - [ ] Test bastion host access to private cluster
  - [ ] Validate Azure RBAC integration
  - [ ] Verify workload identity functionality
  - [ ] Test monitoring and logging data flow
  - [ ] Perform basic cluster health checks

## Dev Notes

### Previous Story Insights
No previous stories exist - this is the first story in the epic.

### Data Models
**Network Configuration** [Source: architecture.md#network-architecture]:
- Management VNet CIDR: 10.250.0.0/16
- Bastion Subnet: 10.250.1.0/24
- Management Cluster Subnet: 10.250.2.0/24
- Private cluster configuration with no public endpoints

**AKS Cluster Configuration** [Source: architecture.md#target-technology-stack]:
- Kubernetes version: "1.29"
- Node provisioning: "Auto" (NAP enabled)
- Network plugin: "azure"
- Network mode: "overlay"
- Network policy: "cilium"
- Network dataplane: "cilium"
- Workload identity: true
- OIDC issuer: true
- Azure RBAC: true
- Pod security standards: "restricted"

**Identity and RBAC Configuration** [Source: architecture.md#security-architecture]:
- User Assigned Managed Identity (UAMI) with cross-subscription permissions
- Custom RBAC roles following principle of least privilege
- Federated identity credentials for workload identity
- Azure Active Directory integration
- Workload identity for all service accounts

### API Specifications
**Azure Service Operator Resource Types** [Source: architecture.md#azure-service-operator]:
- API Version: v1api20240402preview for container service
- Supported Resources: ResourceGroup, ManagedCluster, UserAssignedIdentity, FederatedIdentityCredential, VirtualNetwork, VirtualNetworksSubnet, NetworkSecurityGroup

**AKS API Configuration** [Source: architecture.md#current-state-architecture]:
```json
{
  "type": "Microsoft.ContainerService/managedClusters",
  "apiVersion": "2025-05-02-preview",
  "properties": {
    "nodeProvisioningProfile": {
      "mode": "Auto"
    },
    "networkProfile": {
      "networkPlugin": "azure",
      "networkPolicy": "cilium",
      "networkDataplane": "cilium"
    },
    "securityProfile": {
      "workloadIdentity": {
        "enabled": true
      }
    }
  }
}
```

### Component Specifications
**Management Cluster Components** [Source: architecture.md#target-state-architecture]:
- Azure Service Operator v2 for Azure resource management
- Flux v2 for GitOps continuous delivery
- Monitoring Stack (Prometheus, Grafana, Azure Monitor)
- Security Policies (Pod Security Standards, OPA Gatekeeper)
- Bastion Host for secure access
- Comprehensive logging and monitoring

**Security Controls** [Source: architecture.md#security-architecture]:
- Private clusters with no public API endpoints
- Azure Bastion for secure access
- Network Security Groups with minimal required access
- Workload identity for passwordless authentication
- Azure RBAC integration with conditional access
- Pod security standards enforcement

### File Locations
**Current Project Structure Misalignment** [Source: folder-structure.md]:
- Expected: `eng/azureserviceoperator/managementcluster/`
- Current: `eng/azureserviceoperator-flux/`
- Required structure for management cluster:
  - `rbac/` - RBAC policies for the management cluster
  - `configmap/` - ConfigMaps for management cluster-specific variables
  - `cluster/` - Cluster resource definitions deploys management cluster
  - `identity/` - Identity resources sets up Federation with UAMI
  - `flux/` - Flux configuration resources will deploy worker clusters
  - `maintenanceconfiguration/` - Maintenance window configs
  - `monitoring/` - Prometheus grafana integration, DCR, actiongroups, metricsalerts

### Testing Requirements
No specific testing guidance found in architecture docs - testing strategy will need to be defined for infrastructure provisioning validation.

### Technical Constraints
**Performance Requirements** [Source: prd.md#non-functional-requirements]:
- AKS cluster provisioning within 20 minutes
- 99.9% uptime for management cluster
- Support concurrent provisioning of multiple clusters

**Security Requirements** [Source: prd.md#security-requirements]:
- Zero-trust network architecture
- Principle of least privilege enforcement
- No high-severity vulnerabilities in production
- SOC 2 Type II compliance requirements

### Project Structure Notes
**Structure Alignment Issue**: The current directory structure under `eng/azureserviceoperator-flux/` doesn't align with the expected structure in `docs/folder-structure.md` which shows `eng/azureserviceoperator/managementcluster/`. This misalignment should be addressed during implementation or the folder structure documentation should be updated.

## Testing

### Testing Standards
No specific testing guidance found in architecture docs for infrastructure provisioning. Testing should include:
- Cluster deployment validation
- Network connectivity testing
- RBAC and security validation
- Monitoring and logging verification
- Performance and availability testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after story completion*