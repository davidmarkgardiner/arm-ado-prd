# Story 1.8: ASO Resource Provisioning Testing

<!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** Platform Engineer,
**I want** to test ASO resource provisioning capabilities,
**So that** I can validate the setup before proceeding.

## Acceptance Criteria
1. Test resource group creation in each subscription
2. Test AKS cluster provisioning
3. Test identity resource creation
4. Test resource deletion and cleanup
5. Performance benchmarks established

## Tasks / Subtasks
- [ ] Create test resource group in development subscription (AC: 1)
  - [ ] Deploy test ResourceGroup using ASO CRD
  - [ ] Validate resource group creation in Azure portal
  - [ ] Test proper tagging and naming conventions
  - [ ] Verify cross-subscription permissions work correctly
- [ ] Provision test AKS cluster using ASO (AC: 2)
  - [ ] Deploy minimal AKS cluster for testing
  - [ ] Validate cluster creation with private configuration
  - [ ] Test workload identity and OIDC issuer setup
  - [ ] Verify Node Auto Provisioning functionality
  - [ ] Test cluster connectivity and kubectl access
- [ ] Create user assigned identity and federated credentials (AC: 3)
  - [ ] Deploy UserAssignedIdentity using ASO
  - [ ] Create FederatedIdentityCredential for workload identity
  - [ ] Test identity authentication to Azure APIs
  - [ ] Validate cross-subscription identity access
- [ ] Test resource deletion and cleanup processes (AC: 4)
  - [ ] Test graceful resource deletion via ASO
  - [ ] Validate proper cleanup of dependent resources
  - [ ] Test force deletion scenarios and edge cases
  - [ ] Verify no orphaned resources remain after cleanup
- [ ] Measure provisioning times and performance (AC: 5)
  - [ ] Establish baseline performance metrics
  - [ ] Measure AKS cluster provisioning time (target <20min)
  - [ ] Measure resource group creation time
  - [ ] Test concurrent resource provisioning
  - [ ] Document performance benchmarks and bottlenecks
- [ ] Document test results and benchmarks (AC: 1, 2, 3, 4, 5)
  - [ ] Create comprehensive test report
  - [ ] Document any issues encountered and resolutions
  - [ ] Create troubleshooting guide for common problems
  - [ ] Establish ongoing testing procedures

## Dev Notes

### Previous Story Dependencies
This story builds on:
- Story 1.7 (ASO CRD Templates): Templates must be created and validated
- Story 1.6 (Multi-Subscription Config): Cross-subscription setup must be complete
- Story 1.5 (ASO Installation): ASO must be installed and operational

### Test Resource Specifications
**Test ResourceGroup**:
```yaml
apiVersion: resources.azure.com/v1api20200601
kind: ResourceGroup
metadata:
  name: dev-aso-test-rg-001
  annotations:
    serviceoperator.azure.com/subscription-id: ${DEV_SUBSCRIPTION_ID}
spec:
  location: eastus
  tags:
    environment: "development"
    managed-by: "aso"
    purpose: "testing"
    auto-cleanup: "true"
```

**Test AKS Cluster**:
```yaml
apiVersion: containerservice.azure.com/v1api20240402preview
kind: ManagedCluster
metadata:
  name: dev-aso-test-aks-001
spec:
  location: eastus
  owner:
    name: dev-aso-test-rg-001
  identity:
    type: UserAssigned
    userAssignedIdentities:
      - reference:
          name: dev-aso-test-identity-001
  nodeProvisioningProfile:
    mode: Auto
  agentPoolProfiles:
    - name: system
      mode: System
      vmSize: Standard_D2s_v3
      count: 1
      osType: Linux
  networkProfile:
    networkPlugin: azure
    networkPluginMode: overlay
    networkPolicy: cilium
  apiServerAccessProfile:
    enablePrivateCluster: true
  securityProfile:
    workloadIdentity:
      enabled: true
  oidcIssuerProfile:
    enabled: true
```

### Performance Benchmarks
**Target Performance Metrics** [Source: architecture.md#technical-constraints]:
```yaml
performance_targets:
  resource_group_creation: "<2 minutes"
  aks_cluster_provisioning: "<20 minutes"
  identity_resource_creation: "<5 minutes"
  resource_deletion: "<10 minutes"

concurrent_operations:
  max_parallel_resource_groups: 10
  max_parallel_clusters: 3
  azure_api_rate_limits: "monitor and respect"

reliability_targets:
  resource_creation_success_rate: ">95%"
  cleanup_success_rate: "100%"
  idempotent_operations: "100%"
```

### Testing Scenarios
**Positive Test Cases**:
1. Basic resource provisioning across subscriptions
2. Complex resource dependencies (VNet → Subnet → AKS)
3. Workload identity integration testing
4. Resource tagging and naming convention compliance
5. Concurrent resource provisioning

**Negative Test Cases**:
1. Invalid RBAC permissions
2. Network connectivity issues
3. Azure API throttling scenarios
4. Resource quota limitations
5. Malformed CRD specifications

**Edge Cases**:
1. Resource cleanup during provisioning
2. Azure service outages
3. Kubernetes API server unavailability
4. Large-scale resource provisioning
5. Cross-region resource dependencies

### Monitoring During Testing
**Metrics to Collect**:
- ASO controller resource utilization
- Azure API call patterns and rate limits
- Resource provisioning success/failure rates
- Time-to-completion for each resource type
- Network latency to Azure APIs
- Error patterns and retry behaviors

### Test Automation
**Automated Test Suite**:
```bash
#!/bin/bash
# ASO Resource Provisioning Test Suite

echo "Starting ASO resource provisioning tests..."

# Test 1: Resource Group Creation
kubectl apply -f test-resources/resource-group.yaml
wait_for_condition "resourcegroup/dev-aso-test-rg-001" "Ready"

# Test 2: Identity Resources
kubectl apply -f test-resources/user-assigned-identity.yaml
wait_for_condition "userassignedidentity/dev-aso-test-identity-001" "Ready"

# Test 3: AKS Cluster (long-running)
kubectl apply -f test-resources/managed-cluster.yaml
wait_for_condition "managedcluster/dev-aso-test-aks-001" "Ready" 1200

# Test 4: Cleanup
kubectl delete -f test-resources/
wait_for_deletion "all test resources" 600

echo "ASO provisioning tests completed"
```

### File Locations
**Test Resources Structure**:
```
eng/azureserviceoperator/testing/
├── test-resources/
│   ├── resource-group.yaml
│   ├── user-assigned-identity.yaml
│   ├── managed-cluster.yaml
│   └── virtual-network.yaml
├── test-scripts/
│   ├── provisioning-test.sh
│   ├── performance-benchmark.sh
│   └── cleanup-verification.sh
└── test-results/
    ├── performance-benchmarks.md
    └── test-reports/
```

## Testing

### Functional Testing
- Cross-subscription resource provisioning validation
- Resource dependency and ordering verification
- Error handling and retry mechanism testing
- Resource status reporting accuracy testing

### Performance Testing
- Resource provisioning time measurement
- Concurrent provisioning load testing
- Azure API rate limit handling validation
- Controller resource utilization monitoring

### Security Testing
- RBAC permission boundary testing
- Workload identity authentication validation
- Cross-subscription access control verification
- Audit logging completeness testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*