# Story 2.3: Development Cluster Deployment via ASO

<!-- Powered by BMADâ„¢ Core -->

## Status
Draft

## Story
**As a** Platform Engineer,
**I want** to deploy the development cluster using ASO,
**So that** I can validate the end-to-end GitOps workflow.

## Acceptance Criteria
1. Development AKS cluster provisioned via ASO
2. Node Auto Provisioning enabled and functional
3. Networking and security configured correctly
4. Workload identity operational
5. Monitoring and logging functional

## Tasks / Subtasks
- [ ] Commit development manifests to Git repository (AC: 1)
  - [ ] Organize development manifests in proper Git structure
  - [ ] Commit all ASO resource manifests for development
  - [ ] Tag commit for development environment deployment
  - [ ] Configure Flux Kustomization for development environment
- [ ] Monitor Flux reconciliation of development resources (AC: 1)
  - [ ] Watch Flux source controller sync Git changes
  - [ ] Monitor Kustomization controller resource application
  - [ ] Track ASO controller resource reconciliation
  - [ ] Validate variable substitution during deployment
- [ ] Validate AKS cluster deployment and configuration (AC: 1, 2, 3)
  - [ ] Verify cluster creation in Azure portal
  - [ ] Validate cluster private configuration
  - [ ] Test cluster connectivity through bastion
  - [ ] Verify node pools and scaling configuration
  - [ ] Test kubectl access and cluster operations
- [ ] Test Node Auto Provisioning functionality (AC: 2)
  - [ ] Deploy test workloads to trigger NAP
  - [ ] Verify automatic node provisioning
  - [ ] Test node pool scaling behavior
  - [ ] Validate node pool configuration and taints
  - [ ] Test workload scheduling across node pools
- [ ] Verify networking and security configurations (AC: 3)
  - [ ] Test cluster private API server access
  - [ ] Validate network security group rules
  - [ ] Test pod-to-pod networking with Cilium
  - [ ] Verify DNS resolution and service discovery
  - [ ] Test ingress and load balancer functionality
- [ ] Validate workload identity setup (AC: 4)
  - [ ] Test workload identity authentication
  - [ ] Verify federated identity credential configuration
  - [ ] Test Azure service access from pods
  - [ ] Validate OIDC token exchange
  - [ ] Test cross-subscription resource access

## Dev Notes

### Previous Story Dependencies
This story builds on:
- Story 2.2 (Development ASO Manifests): Manifests must be created and validated
- Story 2.1 (Migration Preparation): Migration plan and procedures established
- Epic 1: Management cluster with ASO and Flux operational

### Development Cluster Specifications
**Target Development Cluster Configuration** [Source: architecture.md#target-technology-stack]:
```yaml
development_cluster:
  basic_configuration:
    name: "dev-workloads-aks-001"
    kubernetes_version: "1.29"
    location: "eastus"
    private_cluster: true

  node_provisioning:
    mode: "Auto"
    system_pool:
      min_nodes: 1
      max_nodes: 3
      vm_size: "Standard_D4s_v3"
    user_pool:
      min_nodes: 0
      max_nodes: 10
      vm_size: "Standard_D4s_v3"

  networking:
    plugin: "azure"
    mode: "overlay"
    policy: "cilium"
    dataplane: "cilium"
    service_cidr: "172.16.0.0/16"
    pod_cidr: "10.244.0.0/16"

  security:
    workload_identity: true
    oidc_issuer: true
    private_cluster: true
    pod_security_standards: "restricted"
```

### GitOps Deployment Flow
**Development Environment Kustomization**:
```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: development-infrastructure
  namespace: flux-system
spec:
  interval: 5m
  path: "./environments/development"
  prune: true
  timeout: 30m
  sourceRef:
    kind: GitRepository
    name: infrastructure
  postBuild:
    substitute:
      ENVIRONMENT: "dev"
      SUBSCRIPTION_ID: "11111111-1111-1111-1111-111111111111"
    substituteFrom:
      - kind: ConfigMap
        name: dev-environment-variables
      - kind: Secret
        name: dev-environment-secrets
  healthChecks:
    - apiVersion: resources.azure.com/v1api20200601
      kind: ResourceGroup
      name: dev-workloads-rg-001
    - apiVersion: managedidentity.azure.com/v1api20230131
      kind: UserAssignedIdentity
      name: dev-workloads-identity-001
    - apiVersion: network.azure.com/v1api20201101
      kind: VirtualNetwork
      name: dev-workloads-vnet-001
    - apiVersion: containerservice.azure.com/v1api20240402preview
      kind: ManagedCluster
      name: dev-workloads-aks-001
  dependsOn:
    - name: azure-service-operator-base
```

### Deployment Monitoring
**Development Deployment Monitoring Script**:
```bash
#!/bin/bash
# monitor-dev-deployment.sh

echo "Monitoring development cluster deployment..."

# 1. Monitor Flux reconciliation
echo "Checking Flux Kustomization status..."
kubectl get kustomization development-infrastructure -n flux-system -w &
FLUX_PID=$!

# 2. Monitor ASO resource creation
echo "Monitoring ASO resource reconciliation..."
kubectl get resourcegroup,managedcluster,userassignedidentity,virtualnetwork -A -w &
ASO_PID=$!

# 3. Check Azure resource creation
echo "Monitoring Azure resource creation..."
while true; do
  echo "=== $(date) ==="

  # Check Resource Group
  az group show --name dev-workloads-rg-001 --query "provisioningState" -o tsv 2>/dev/null || echo "RG: Not found"

  # Check AKS Cluster
  az aks show --resource-group dev-workloads-rg-001 --name dev-workloads-aks-001 --query "provisioningState" -o tsv 2>/dev/null || echo "AKS: Not found"

  # Check if cluster is ready
  if az aks show --resource-group dev-workloads-rg-001 --name dev-workloads-aks-001 --query "provisioningState" -o tsv 2>/dev/null | grep -q "Succeeded"; then
    echo "Development cluster deployment completed!"
    break
  fi

  sleep 60
done

# Cleanup background processes
kill $FLUX_PID $ASO_PID 2>/dev/null

echo "Development cluster deployment monitoring completed"
```

### Node Auto Provisioning Testing
**NAP Functionality Validation**:
```bash
#!/bin/bash
# test-node-auto-provisioning.sh

echo "Testing Node Auto Provisioning functionality..."

# Get cluster credentials
az aks get-credentials --resource-group dev-workloads-rg-001 --name dev-workloads-aks-001 --admin

# 1. Check initial node state
echo "Initial node state:"
kubectl get nodes -o wide

# 2. Deploy test workload to trigger NAP
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nap-test-workload
  namespace: default
spec:
  replicas: 5
  selector:
    matchLabels:
      app: nap-test
  template:
    metadata:
      labels:
        app: nap-test
    spec:
      containers:
      - name: stress-test
        image: polinux/stress
        resources:
          requests:
            cpu: 1000m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 1Gi
        command: ["stress"]
        args: ["--cpu", "1", "--timeout", "600s"]
      nodeSelector:
        nodepool-type: "user"
EOF

# 3. Monitor node provisioning
echo "Monitoring node provisioning..."
for i in {1..20}; do
  echo "=== Check $i - $(date) ==="
  kubectl get nodes -o wide
  kubectl get pods -n default

  # Check if new nodes are provisioned
  NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
  if [ $NODE_COUNT -gt 1 ]; then
    echo "Node Auto Provisioning triggered - new nodes detected!"
  fi

  sleep 30
done

# 4. Cleanup test workload
kubectl delete deployment nap-test-workload -n default

echo "Node Auto Provisioning test completed"
```

### Workload Identity Validation
**Workload Identity Testing**:
```yaml
# Test workload identity functionality
apiVersion: v1
kind: ServiceAccount
metadata:
  name: workload-identity-test-sa
  namespace: default
  annotations:
    azure.workload.identity/client-id: "${IDENTITY_CLIENT_ID}"
---
apiVersion: v1
kind: Pod
metadata:
  name: workload-identity-test
  namespace: default
  labels:
    azure.workload.identity/use: "true"
spec:
  serviceAccountName: workload-identity-test-sa
  containers:
  - name: test
    image: mcr.microsoft.com/azure-cli:latest
    command: ["/bin/bash"]
    args: ["-c", "az account show && sleep 3600"]
    env:
    - name: AZURE_CLIENT_ID
      value: "${IDENTITY_CLIENT_ID}"
```

### Network and Security Validation
**Network Connectivity Testing**:
```bash
#!/bin/bash
# test-network-connectivity.sh

echo "Testing network connectivity and security..."

# Get cluster credentials
az aks get-credentials --resource-group dev-workloads-rg-001 --name dev-workloads-aks-001 --admin

# 1. Test DNS resolution
kubectl run dns-test --image=busybox --rm -it --restart=Never -- nslookup kubernetes.default.svc.cluster.local

# 2. Test pod-to-pod connectivity
kubectl run network-test-1 --image=nginx --port=80
kubectl expose pod network-test-1 --type=ClusterIP --port=80
kubectl run network-test-2 --image=busybox --rm -it --restart=Never -- wget -qO- network-test-1

# 3. Test Cilium network policies
kubectl apply -f - <<EOF
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: test-network-policy
  namespace: default
spec:
  endpointSelector:
    matchLabels:
      app: nginx
  ingress:
  - fromEndpoints:
    - matchLabels:
        app: allowed
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP
EOF

# 4. Test load balancer
kubectl create deployment lb-test --image=nginx
kubectl expose deployment lb-test --type=LoadBalancer --port=80

echo "Network connectivity testing completed"
```

### Deployment Success Validation
**Comprehensive Deployment Validation**:
```yaml
validation_checklist:
  infrastructure:
    - resource_group_created: "dev-workloads-rg-001"
    - virtual_network_created: "dev-workloads-vnet-001"
    - aks_cluster_created: "dev-workloads-aks-001"
    - user_assigned_identity_created: "dev-workloads-identity-001"
    - log_analytics_workspace_created: "dev-workloads-law-001"

  cluster_configuration:
    - cluster_private: true
    - workload_identity_enabled: true
    - node_auto_provisioning_enabled: true
    - cilium_network_policy_enabled: true
    - monitoring_addon_enabled: true

  operational:
    - kubectl_access_working: true
    - node_pools_scaling: true
    - workload_identity_functional: true
    - monitoring_data_flowing: true
    - gitops_reconciliation_working: true
```

## Testing

### Deployment Validation Testing
- GitOps workflow end-to-end testing
- ASO resource reconciliation validation
- Azure resource creation verification
- Cluster configuration compliance testing

### Functionality Testing
- Node Auto Provisioning behavior validation
- Workload identity authentication testing
- Network connectivity and security testing
- Monitoring and logging data collection

### Integration Testing
- Flux and ASO integration validation
- Cross-subscription resource access testing
- Security policy enforcement verification
- Performance baseline establishment

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after story completion*